<%@page contentType="text/html;charset=UTF-8" language="java" import="java.sql.*"%>
<%@include file="back/config.html" %>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bg.css">
    <link rel="stylesheet" href="css/h.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@300;400;500;600;700&display=swap" rel="stylesheet"> <!--英文字體-->
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <title>bg</title>
</head>
<body>
    <div id="id_wrapper">
    <!-- 導覽列 -->
    <div id="id_header">
    <header>
        <nav>
            <ul class="nav_center">
                <li><a href="index.html"><img class="logo" src="img/logo.png"></a></li>
                <li><a href="bg_product.html">商品管理</a></li>
                <li><a href="bg_order.html">訂單管理</a></li>
                <li><a href="bg_comment.html">留言板管理</a></li>
				<form action="back/logout.html" method="post">
					<input type="submit" class="w3-bar-item w3-button" value="登出"></input>
				</form>
				<%
		//判斷是否登入
		if(session.getAttribute("id") == null ){
			response.sendRedirect("index.html");
		%>    
        
    

                                
                  
      
                
            </ul>
        </nav>
    </header>
    </div>
    <script src="js/h.js"></script>
    <!-- 導覽列結束 -->
    <div id="id_content">
        <div class="cpo">
		<%
try {
//Step 1: 載入資料庫驅動程式 
    Class.forName("com.mysql.jdbc.Driver");
    try {
//Step 2: 建立連線  
        if(con.isClosed())
           out.println("連線建立失敗");
        else {
//Step 3: 選擇資料庫   
           sql="USE `final`";
           con.createStatement().execute(sql);
//Step 4: 執行 SQL 指令, 若要操作記錄集, 需使用executeQuery, 才能傳回ResultSet  
           /*使用getRow()查詢筆數
       sql="SELECT * FROM `guestbook`"; //算出共幾筆留言
           ResultSet rs=con.createStatement().executeQuery(sql);

           //先移到檔尾, getRow()後, 就可知道共有幾筆記錄
           rs.last();
           int total_content=rs.getRow();
           */
       //使用COUNT()查詢筆數
       sql="SELECT COUNT(*) FROM `board`"; //算出共幾筆留言
           ResultSet rs=con.createStatement().executeQuery(sql);

           //移到第一筆，使用rs.getInt(1)，1表第一個欄位，就可知道共有幾筆記錄，型別為整數
           rs.next();
       int total_content=rs.getInt(1);
       //int total_content=Integer.parseInt(rs.getString(1));
       
           
           //每頁顯示5筆, 算出共幾頁
           int page_num=(int)Math.ceil((double)total_content/3.0); //無條件進位
           
           //使用超連結方式, 呼叫自己, 使用get方式傳遞參數(變數名稱為page)
           for(int i=1;i<=page_num;i++) //建立1,2,...頁超連結
           out.print("<a href='bg_comment.html?n="+i+"'>"+i+"</a>&nbsp;"); //&nbsp;html的空白

           out.println("<br><br>");

           //讀取page變數
           String page_string = request.getParameter("n");
           if (page_string == null) 
               page_string = "0";          
           int current_page=Integer.valueOf(page_string);
           if(current_page==0) //若未指定page, 令current_page為1
            current_page=1;
         //計算開始記錄位置   
//Step 5: 顯示結果 
           int start_record=(current_page-1)*3;
           //遞減排序, 讓最新的資料排在最前面
           sql="SELECT * FROM `board` ORDER BY `id` DESC LIMIT ";
           sql+=start_record+",3";

//      current_page... SELECT * FROM `guestbook` ORDER BY `GBNO` DESC LIMIT
//      current_page=1: SELECT * FROM `guestbook` ORDER BY `GBNO` DESC LIMIT 0, 3
//      current_page=2: SELECT * FROM `guestbook` ORDER BY `GBNO` DESC LIMIT 3, 3
//      current_page=3: SELECT * FROM `guestbook` ORDER BY `GBNO` DESC LIMIT 6, 3

           rs=con.createStatement().executeQuery(sql);
//  逐筆顯示, 直到沒有資料(最多還是5筆)
%>
<%
           while(rs.next())
                {
%>
            <form action="back/delete.html">
			<div>
                編號:<%=rs.getString(1)%><br>
                姓名:<%=rs.getString(2)%><br>
                評論:<%=rs.getString(3)%><br>
				日期:<%=rs.getString(4)%><br>
                星級:<%=rs.getString(5)%><br>
				<input  type="text" placeholder="請輸入編號..." name="aa" required="required" style="width: 150px;"/>
                <input type="submit" value="刪除"> <br>
                ---------------------------------------------------------------------------------- <br>
            </div>
			</form>
			<%
          }
		  out.println("共"+total_content+"筆留言<p>");
//Step 6: 關閉連線
          con.close();
      }
    }
    catch (SQLException sExec) {
           out.println("SQL錯誤"+sExec.toString());
       
    }
}
catch (ClassNotFoundException err) {
      out.println("class錯誤"+err.toString());
}
%>
        </div>
    </div>
    
    
    <footer  id="id_footer">
        <div class="foot">
            <p>Copyright © 2020 Chung Yuan Christian University All Rights</p>
        </div>
    </footer>
    </div>
    

</body>
</html>